<!DOCTYPE html>
<html>
<head>
  <title>SysAutopsy | Digital Forensics Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Inter', sans-serif;
      background: #0f0f14;
      min-height: 100vh;
      color: #e4e4e7;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle at 20% 50%, rgba(139, 92, 246, 0.03) 0%, transparent 50%),
                  radial-gradient(circle at 80% 80%, rgba(99, 102, 241, 0.03) 0%, transparent 50%);
      animation: backgroundShift 20s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes backgroundShift {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      50% { transform: translate(5%, 5%) rotate(1deg); }
    }

    .dashboard {
      position: relative;
      z-index: 1;
    }

    /* Top Navigation */
    .top-nav {
      background: rgba(20, 20, 28, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      padding: 16px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 42px;
      height: 42px;
      background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 4px 20px rgba(139, 92, 246, 0.3);
      animation: float 3s ease-in-out infinite;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .logo-icon:hover {
      transform: scale(1.1) rotate(5deg);
      box-shadow: 0 6px 30px rgba(139, 92, 246, 0.5);
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-5px) rotate(2deg); }
    }

    .logo h1 {
      font-size: 1.4rem;
      font-weight: 700;
      color: #fff;
    }

    .logo span {
      color: #8b5cf6;
    }

    .nav-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: #71717a;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      background: #22c55e;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { 
        opacity: 1; 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
      }
      50% { 
        opacity: 0.7; 
        transform: scale(1.1);
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0);
      }
    }

    /* Main Layout */
    .dashboard {
      display: grid;
      grid-template-columns: 320px 1fr;
      min-height: calc(100vh - 74px);
    }

    /* Sidebar */
    .sidebar {
      background: rgba(20, 20, 28, 0.6);
      border-right: 1px solid rgba(255, 255, 255, 0.08);
      padding: 30px 24px;
    }

    .sidebar-section {
      margin-bottom: 30px;
    }

    .sidebar-section h4 {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: #52525b;
      margin-bottom: 16px;
      padding-left: 4px;
    }

    /* Upload Card */
    .upload-card {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(99, 102, 241, 0.05) 100%);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 16px;
      padding: 24px;
    }

    .upload-zone {
      border: 2px dashed rgba(139, 92, 246, 0.3);
      border-radius: 12px;
      padding: 30px 20px;
      text-align: center;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      background: rgba(139, 92, 246, 0.03);
      position: relative;
      overflow: hidden;
    }

    .upload-zone::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(139, 92, 246, 0.1);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s ease, height 0.6s ease;
    }

    .upload-zone:hover {
      border-color: #8b5cf6;
      background: rgba(139, 92, 246, 0.08);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(139, 92, 246, 0.15);
    }

    .upload-zone:hover::before {
      width: 300px;
      height: 300px;
    }

    .upload-zone.dragover {
      border-color: #8b5cf6;
      background: rgba(139, 92, 246, 0.12);
      transform: scale(1.02);
      animation: shake 0.5s ease;
    }

    @keyframes shake {
      0%, 100% { transform: scale(1.02) translateX(0); }
      25% { transform: scale(1.02) translateX(-5px); }
      75% { transform: scale(1.02) translateX(5px); }
    }

    .upload-icon {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .upload-zone h3 {
      font-size: 0.95rem;
      margin-bottom: 6px;
      color: #fff;
    }

    .upload-zone p {
      color: #71717a;
      font-size: 0.75rem;
    }

    .file-name {
      margin-top: 12px;
      padding: 8px 14px;
      background: rgba(139, 92, 246, 0.2);
      border-radius: 6px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      color: #a5b4fc;
      display: none;
      animation: slideInBounce 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    @keyframes slideInBounce {
      0% {
        opacity: 0;
        transform: translateY(-20px) scale(0.8);
      }
      100% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    #logfile { display: none; }

    /* Buttons */
    .btn {
      width: 100%;
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-family: 'Inter', sans-serif;
      margin-top: 12px;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
      color: white;
      box-shadow: 0 4px 20px rgba(139, 92, 246, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 8px 30px rgba(139, 92, 246, 0.5);
    }

    .btn-primary:active {
      transform: translateY(0) scale(0.98);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.06);
      color: #a1a1aa;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    .btn-download {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      font-size: 0.85rem;
      padding: 10px 18px;
      width: auto;
      margin: 0;
    }

    .btn-download:hover {
      box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
    }

    /* Past Reports in Sidebar */
    .past-reports-list {
      display: none;
    }

    .past-reports-list.active {
      display: block;
    }

    .past-report-item {
      padding: 12px 14px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 3px solid #6366f1;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      animation: slideInLeft 0.4s ease forwards;
      opacity: 0;
    }

    .past-report-item:nth-child(1) { animation-delay: 0.05s; }
    .past-report-item:nth-child(2) { animation-delay: 0.1s; }
    .past-report-item:nth-child(3) { animation-delay: 0.15s; }
    .past-report-item:nth-child(4) { animation-delay: 0.2s; }
    .past-report-item:nth-child(5) { animation-delay: 0.25s; }
    .past-report-item:nth-child(6) { animation-delay: 0.3s; }
    .past-report-item:nth-child(7) { animation-delay: 0.35s; }
    .past-report-item:nth-child(8) { animation-delay: 0.4s; }
    .past-report-item:nth-child(9) { animation-delay: 0.45s; }
    .past-report-item:nth-child(10) { animation-delay: 0.5s; }

    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .past-report-item:hover {
      background: rgba(255, 255, 255, 0.06);
      transform: translateX(8px);
      border-left-width: 5px;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
    }

    .past-report-item strong {
      color: #fff;
      display: block;
      margin-bottom: 4px;
    }

    .past-report-item span {
      color: #71717a;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
    }

    /* Pagination Controls */
    .pagination-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    .pagination-btn {
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #a1a1aa;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .pagination-btn:hover:not(:disabled) {
      background: rgba(139, 92, 246, 0.2);
      border-color: rgba(139, 92, 246, 0.4);
      color: #fff;
    }

    .pagination-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .pagination-info {
      font-size: 0.7rem;
      color: #52525b;
      font-family: 'JetBrains Mono', monospace;
    }

    /* Main Content */
    .main-content {
      padding: 30px;
      overflow-y: auto;
    }

    /* Loading State */
    .loading {
      display: none;
      text-align: center;
      padding: 80px 40px;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(139, 92, 246, 0.2);
      border-top-color: #8b5cf6;
      border-bottom-color: #6366f1;
      border-radius: 50%;
      animation: spin 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite, pulse-spinner 1.5s ease-in-out infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes pulse-spinner {
      0%, 100% { 
        box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4);
      }
      50% { 
        box-shadow: 0 0 0 10px rgba(139, 92, 246, 0);
      }
    }

    .loading p {
      color: #71717a;
      font-size: 0.95rem;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 100px 40px;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.3;
      animation: floatSlow 4s ease-in-out infinite;
      display: inline-block;
    }

    @keyframes floatSlow {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-15px); }
    }

    .empty-state h3 {
      font-size: 1.3rem;
      color: #52525b;
      margin-bottom: 8px;
    }

    .empty-state p {
      color: #3f3f46;
      font-size: 0.9rem;
    }

    /* Results */
    #result {
      display: none;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Stats Grid - Top Row */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: rgba(25, 25, 35, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      overflow: hidden;
      animation: fadeInUp 0.6s ease forwards;
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .stat-card:nth-child(1) { animation-delay: 0.1s; }
    .stat-card:nth-child(2) { animation-delay: 0.2s; }
    .stat-card:nth-child(3) { animation-delay: 0.3s; }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .stat-card:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      border-color: rgba(255, 255, 255, 0.12);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background-size: 200% 100%;
      animation: gradientShift 3s ease infinite;
    }

    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .stat-card.critical::before { 
      background: linear-gradient(90deg, #ef4444, #dc2626, #ef4444); 
    }
    .stat-card.warning::before { 
      background: linear-gradient(90deg, #f59e0b, #d97706, #f59e0b); 
    }
    .stat-card.info::before { 
      background: linear-gradient(90deg, #3b82f6, #2563eb, #3b82f6); 
    }

    .stat-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .stat-card-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #71717a;
    }

    .stat-card-icon {
      font-size: 20px;
    }

    .stat-card-value {
      font-size: 1.6rem;
      font-weight: 700;
      color: #fff;
      font-family: 'JetBrains Mono', monospace;
      line-height: 1.2;
    }

    .stat-card-sub {
      font-size: 0.8rem;
      color: #52525b;
      margin-top: 8px;
    }

    /* Two Column Layout */
    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 24px;
    }

    /* Cards */
    .card {
      background: rgba(25, 25, 35, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      animation: fadeInScale 0.5s ease forwards;
      opacity: 0;
    }

    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .card:hover {
      border-color: rgba(255, 255, 255, 0.12);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      transform: translateY(-3px);
    }

    .card-header {
      padding: 20px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-header h3 {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.95rem;
      font-weight: 600;
      color: #fff;
    }

    .card-body {
      padding: 20px 24px;
    }

    /* Intervention Card - Special Styling */
    .intervention-card {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.08) 0%, rgba(217, 119, 6, 0.04) 100%);
      border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .intervention-card .card-header {
      border-bottom-color: rgba(245, 158, 11, 0.15);
    }

    .intervention-card h3 { color: #fcd34d; }

    .intervention-text {
      color: #fef3c7;
      font-size: 0.9rem;
      line-height: 1.6;
    }

    /* Postmortem Card */
    .postmortem-card {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(37, 99, 235, 0.04) 100%);
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .postmortem-card .card-header {
      border-bottom-color: rgba(59, 130, 246, 0.15);
    }

    .postmortem-card h3 { color: #93c5fd; }

    .postmortem-list {
      list-style: none;
    }

    .postmortem-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .postmortem-list li:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .postmortem-list li:first-child {
      padding-top: 0;
    }

    .postmortem-list b {
      color: #93c5fd;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .postmortem-list span {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      color: #fff;
      text-align: right;
      max-width: 60%;
    }

    /* Timeline */
    .timeline-list {
      list-style: none;
      position: relative;
      padding: 10px 0;
    }

    .timeline-list::before {
      content: '';
      position: absolute;
      left: 5px;
      top: 8px;
      bottom: 8px;
      width: 3px;
      background: linear-gradient(180deg, 
        rgba(139, 92, 246, 0.6) 0%,
        rgba(139, 92, 246, 0.3) 50%,
        rgba(139, 92, 246, 0.1) 100%);
      animation: lineGrow 1.5s ease-out forwards;
      transform-origin: top;
      box-shadow: 0 0 10px rgba(139, 92, 246, 0.3);
    }

    @keyframes lineGrow {
      from {
        height: 0;
        opacity: 0;
      }
      to {
        height: 100%;
        opacity: 1;
      }
    }

    .timeline-list li {
      position: relative;
      padding: 16px 20px 16px 38px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.82rem;
      color: #a1a1aa;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      background: rgba(255, 255, 255, 0.01);
      border-radius: 8px;
      margin-bottom: 12px;
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      transform: translateY(-20px) rotateX(-90deg);
      transform-origin: top;
      transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      backdrop-filter: blur(10px);
    }

    .timeline-list li.visible {
      opacity: 1;
      max-height: 200px;
      transform: translateY(0) rotateX(0deg);
      padding: 16px 20px 16px 38px;
    }

    .timeline-list li.visible:hover {
      background: rgba(255, 255, 255, 0.05);
      transform: translateX(8px) scale(1.02) rotateX(0deg);
      box-shadow: -4px 0 15px rgba(139, 92, 246, 0.2);
      color: #e4e4e7;
    }

    .timeline-list li:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    /* Severity-based styling */
    .timeline-list li.critical {
      border-left: 3px solid rgba(239, 68, 68, 0.5);
      background: rgba(239, 68, 68, 0.03);
    }

    .timeline-list li.critical.visible:hover {
      background: rgba(239, 68, 68, 0.08);
      box-shadow: -4px 0 20px rgba(239, 68, 68, 0.3);
    }

    .timeline-list li.warning {
      border-left: 3px solid rgba(245, 158, 11, 0.5);
      background: rgba(245, 158, 11, 0.03);
    }

    .timeline-list li.warning.visible:hover {
      background: rgba(245, 158, 11, 0.08);
      box-shadow: -4px 0 20px rgba(245, 158, 11, 0.3);
    }

    .timeline-list li.info {
      border-left: 3px solid rgba(59, 130, 246, 0.5);
      background: rgba(59, 130, 246, 0.03);
    }

    .timeline-list li.info.visible:hover {
      background: rgba(59, 130, 246, 0.08);
      box-shadow: -4px 0 20px rgba(59, 130, 246, 0.3);
    }

    .timeline-list li::before {
      content: '';
      position: absolute;
      left: -2px;
      top: 20px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #8b5cf6;
      border: 3px solid #0f0f14;
      box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7),
                  0 0 15px rgba(139, 92, 246, 0.5);
      z-index: 2;
      transform: scale(0);
      transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .timeline-list li.visible::before {
      transform: scale(1);
      animation: dotPulse 2s ease-in-out infinite;
    }

    @keyframes dotPulse {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7),
                    0 0 15px rgba(139, 92, 246, 0.5);
      }
      50% {
        box-shadow: 0 0 0 6px rgba(139, 92, 246, 0),
                    0 0 25px rgba(139, 92, 246, 0.8);
      }
    }

    .timeline-list li.critical::before { 
      background: #ef4444;
      border-color: #0f0f14;
      box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7),
                  0 0 20px rgba(239, 68, 68, 0.6);
    }

    .timeline-list li.critical.visible::before {
      animation: dotPulseCritical 2s ease-in-out infinite;
    }
    
    .timeline-list li.warning::before { 
      background: #f59e0b;
      border-color: #0f0f14;
      box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7),
                  0 0 20px rgba(245, 158, 11, 0.6);
    }

    .timeline-list li.warning.visible::before {
      animation: dotPulseWarning 2s ease-in-out infinite;
    }
    
    .timeline-list li.info::before { 
      background: #3b82f6;
      border-color: #0f0f14;
      box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7),
                  0 0 20px rgba(59, 130, 246, 0.6);
    }

    .timeline-list li.info.visible::before {
      animation: dotPulseInfo 2s ease-in-out infinite;
    }

    @keyframes dotPulseCritical {
      0%, 100% { 
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7),
                    0 0 20px rgba(239, 68, 68, 0.6);
      }
      50% { 
        box-shadow: 0 0 0 6px rgba(239, 68, 68, 0),
                    0 0 30px rgba(239, 68, 68, 0.9);
      }
    }

    @keyframes dotPulseWarning {
      0%, 100% { 
        box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7),
                    0 0 20px rgba(245, 158, 11, 0.6);
      }
      50% { 
        box-shadow: 0 0 0 6px rgba(245, 158, 11, 0),
                    0 0 30px rgba(245, 158, 11, 0.9);
      }
    }

    @keyframes dotPulseInfo {
      0%, 100% { 
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7),
                    0 0 20px rgba(59, 130, 246, 0.6);
      }
      50% { 
        box-shadow: 0 0 0 6px rgba(59, 130, 246, 0),
                    0 0 30px rgba(59, 130, 246, 0.9);
      }
    }

    /* Add glow effect on hover */
    .timeline-list li.visible:hover::before {
      transform: scale(1.3);
      filter: brightness(1.3);
    }

    /* Timeline controls */
    .timeline-controls {
      margin-top: 20px;
      text-align: center;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
    }

    .timeline-count {
      font-size: 0.75rem;
      color: #71717a;
      margin-bottom: 12px;
      font-family: 'JetBrains Mono', monospace;
    }

    .btn-show-more {
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid rgba(139, 92, 246, 0.3);
      color: #a5b4fc;
      padding: 10px 24px;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-family: 'Inter', sans-serif;
    }

    .btn-show-more:hover {
      background: rgba(139, 92, 246, 0.2);
      border-color: rgba(139, 92, 246, 0.5);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
    }

    .btn-show-more:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }

    .btn-show-more:disabled:hover {
      background: rgba(139, 92, 246, 0.1);
      border-color: rgba(139, 92, 246, 0.3);
      transform: none;
      box-shadow: none;
    }

    /* Causes */
    .cause-item {
      margin-bottom: 16px;
    }

    .cause-item:last-child {
      margin-bottom: 0;
    }

    .cause-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .cause-name {
      font-size: 0.85rem;
      color: #e4e4e7;
    }

    .cause-percent {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      font-weight: 600;
      color: #a5b4fc;
    }

    .cause-bar-bg {
      height: 6px;
      background: rgba(139, 92, 246, 0.15);
      border-radius: 3px;
      overflow: hidden;
    }

    .cause-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #8b5cf6, #6366f1, #8b5cf6);
      background-size: 200% 100%;
      border-radius: 3px;
      transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
      animation: shimmer 2s ease-in-out infinite;
      box-shadow: 0 0 10px rgba(139, 92, 246, 0.4);
    }

    @keyframes shimmer {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    /* Explanation */
    .explanation-list {
      list-style: none;
    }

    .explanation-list li {
      padding: 14px 16px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 10px;
      margin-bottom: 10px;
      border-left: 3px solid #6366f1;
      font-size: 0.85rem;
      line-height: 1.5;
      animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
      opacity: 0;
      transition: all 0.3s ease;
    }

    .explanation-list li:nth-child(1) { animation-delay: 0.1s; }
    .explanation-list li:nth-child(2) { animation-delay: 0.2s; }
    .explanation-list li:nth-child(3) { animation-delay: 0.3s; }
    .explanation-list li:nth-child(4) { animation-delay: 0.4s; }
    .explanation-list li:nth-child(5) { animation-delay: 0.5s; }

    @keyframes bounceIn {
      0% {
        opacity: 0;
        transform: scale(0.3) translateY(20px);
      }
      50% {
        transform: scale(1.05) translateY(-5px);
      }
      70% {
        transform: scale(0.97) translateY(2px);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .explanation-list li:hover {
      background: rgba(255, 255, 255, 0.05);
      transform: translateX(5px);
      border-left-width: 5px;
    }

    .explanation-list li:last-child {
      margin-bottom: 0;
    }

    .explanation-list b {
      color: #a5b4fc;
      display: block;
      margin-bottom: 4px;
    }

    /* Charts Section */
    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 24px;
    }

    .chart-card {
      background: rgba(25, 25, 35, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 16px;
      overflow: hidden;
      animation: zoomIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      opacity: 0;
      transition: all 0.3s ease;
    }

    .charts-grid .chart-card:nth-child(1) { animation-delay: 0.4s; }
    .charts-grid .chart-card:nth-child(2) { animation-delay: 0.5s; }

    @keyframes zoomIn {
      from {
        opacity: 0;
        transform: scale(0.8) rotateX(10deg);
      }
      to {
        opacity: 1;
        transform: scale(1) rotateX(0);
      }
    }

    .chart-card:hover {
      border-color: rgba(255, 255, 255, 0.12);
      transform: translateY(-5px);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .chart-card .card-header {
      padding: 20px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .chart-card .card-header h3 {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.95rem;
      font-weight: 600;
      color: #fff;
    }

    .chart-container {
      padding: 20px;
      height: 280px;
      position: relative;
    }

    .chart-container canvas {
      max-height: 100%;
    }

    /* Severity Legend */
    .severity-legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      padding: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      color: #a1a1aa;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .legend-dot.critical { background: #ef4444; }
    .legend-dot.warning { background: #f59e0b; }
    .legend-dot.info { background: #3b82f6; }

    /* Gauge Chart Styles */
    .gauge-container {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
    }

    .gauge-value {
      position: absolute;
      top: 55%;
      font-size: 2rem;
      font-weight: 700;
      color: #fff;
      font-family: 'JetBrains Mono', monospace;
    }

    .gauge-label {
      margin-top: 10px;
      font-size: 0.85rem;
      color: #71717a;
    }

    /* Incident Metadata Card */
    .incident-metadata-card {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.08) 0%, rgba(99, 102, 241, 0.05) 100%);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-left: 4px solid #8b5cf6;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      animation: slideInBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .incident-metadata-card h3 {
      color: #a78bfa;
      font-size: 1.2rem;
      margin-bottom: 20px;
      font-weight: 600;
    }

    .metadata-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .metadata-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .metadata-label {
      font-size: 0.75rem;
      color: #71717a;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .metadata-value {
      font-size: 0.95rem;
      color: #e4e4e7;
      font-weight: 500;
    }

    .metadata-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      width: fit-content;
    }

    .metadata-badge[data-env="prod"] {
      background: rgba(239, 68, 68, 0.15);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .metadata-badge[data-env="staging"] {
      background: rgba(245, 158, 11, 0.15);
      color: #fcd34d;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .metadata-badge.severity[data-severity="P1"] {
      background: rgba(239, 68, 68, 0.15);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .metadata-badge.severity[data-severity="P2"] {
      background: rgba(245, 158, 11, 0.15);
      color: #fcd34d;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .metadata-badge.severity[data-severity="P3"] {
      background: rgba(59, 130, 246, 0.15);
      color: #93c5fd;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .metadata-badge.severity[data-severity="P4"] {
      background: rgba(34, 197, 94, 0.15);
      color: #86efac;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .metadata-badge[data-value="Yes"] {
      background: rgba(34, 197, 94, 0.15);
      color: #86efac;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .metadata-badge[data-value="No"] {
      background: rgba(113, 113, 122, 0.15);
      color: #a1a1aa;
      border: 1px solid rgba(113, 113, 122, 0.3);
    }

    /* AI Adaptive Analysis Card */
    .adaptive-analysis-card {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.08) 100%);
      border: 2px solid rgba(99, 102, 241, 0.3);
      border-left: 6px solid #6366f1;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      animation: slideInBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .adaptive-analysis-card h3 {
      color: #818cf8;
      font-size: 1.2rem;
      margin-bottom: 16px;
      font-weight: 600;
    }

    .adaptive-explanation {
      color: #c4b5fd;
      font-size: 0.9rem;
      line-height: 1.8;
      margin-bottom: 20px;
      padding: 12px 12px 12px 32px;
      background: rgba(99, 102, 241, 0.05);
      border-radius: 8px;
      list-style: disc;
    }

    .adaptive-explanation li {
      margin-bottom: 8px;
      color: #c4b5fd;
    }

    .adaptive-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .adaptive-stat {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      border: 1px solid rgba(99, 102, 241, 0.2);
    }

    .adaptive-stat-label {
      font-size: 0.75rem;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .adaptive-stat-value {
      font-size: 1.1rem;
      color: #e0e7ff;
      font-weight: 700;
    }

    .adaptive-stat-value.risk-CRITICAL {
      color: #fca5a5;
    }

    .adaptive-stat-value.risk-HIGH {
      color: #fcd34d;
    }

    .adaptive-stat-value.risk-MEDIUM {
      color: #93c5fd;
    }

    .adaptive-stat-value.risk-LOW {
      color: #86efac;
    }

    .similar-incidents {
      margin-top: 16px;
    }

    .similar-incident-item {
      background: rgba(255, 255, 255, 0.03);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 3px solid #6366f1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .similar-incident-cause {
      color: #c4b5fd;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .similar-incident-match {
      color: #818cf8;
      font-size: 0.85rem;
      font-weight: 600;
    }

    /* AI Similarity Visualization */
    .similarity-box {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%);
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-left: 6px solid #3b82f6;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      animation: slideInBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .similarity-box h3 {
      color: #93c5fd;
      font-size: 1.1rem;
      margin-bottom: 12px;
      font-weight: 600;
    }

    .similarity-box p {
      color: #bfdbfe;
      font-size: 0.95rem;
      margin-bottom: 16px;
      line-height: 1.6;
    }

    .similarity-bar {
      position: relative;
      height: 24px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .similarity-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
      transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 12px;
    }

    .similarity-percentage {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
      font-weight: 700;
      font-size: 0.85rem;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    }

    /* GenAI Explanation Card */
    .genai-explanation-card {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.08) 0%, rgba(5, 150, 105, 0.04) 100%);
      border: 2px solid rgba(16, 185, 129, 0.3);
      border-left: 6px solid #10b981;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      animation: slideInBounce 0.7s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .genai-explanation-card h3 {
      color: #6ee7b7;
      font-size: 1.2rem;
      margin-bottom: 16px;
      font-weight: 600;
    }

    .genai-content {
      color: #d1fae5;
      font-size: 0.95rem;
      line-height: 1.8;
      white-space: pre-wrap;
      font-family: 'Inter', sans-serif;
    }

    .genai-content p {
      margin-bottom: 16px;
    }


    /* Risk Warning Card */
    .risk-warning-card {
      display: none;
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.05) 100%);
      border: 2px solid rgba(239, 68, 68, 0.3);
      border-left: 6px solid #ef4444;
      border-radius: 16px;
      padding: 20px 24px;
      margin-bottom: 24px;
      animation: slideInAlert 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      opacity: 0;
    }

    @keyframes slideInAlert {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .risk-warning-card h3 {
      color: #fca5a5;
      font-size: 1.1rem;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .risk-warning-card h3::before {
      content: 'âš ';
      font-size: 1.5rem;
      animation: warningPulse 1.5s ease-in-out infinite;
    }

    @keyframes warningPulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.6;
        transform: scale(1.1);
      }
    }

    .risk-warning-card p {
      color: #fecaca;
      font-size: 0.95rem;
      line-height: 1.6;
      margin-bottom: 8px;
    }

    .risk-warning-card .similarity-badge {
      display: inline-block;
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.4);
      padding: 4px 12px;
      border-radius: 20px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      font-weight: 600;
      color: #fca5a5;
      margin-top: 8px;
    }

    /* AI Chatbot Styles */
    .chatbot-button {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
      transition: all 0.3s ease;
      z-index: 1000;
      animation: pulse 2s infinite;
    }

    .chatbot-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 30px rgba(139, 92, 246, 0.6);
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4); }
      50% { box-shadow: 0 4px 30px rgba(139, 92, 246, 0.7); }
    }

    .chatbot-window {
      position: fixed;
      bottom: 100px;
      right: 30px;
      width: 400px;
      height: 600px;
      background: rgba(20, 20, 28, 0.98);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      display: none;
      flex-direction: column;
      z-index: 1000;
      animation: slideUp 0.3s ease;
    }

    .chatbot-window.open {
      display: flex;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .chatbot-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chatbot-header h3 {
      font-size: 1.1rem;
      font-weight: 600;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chatbot-close {
      background: none;
      border: none;
      color: #999;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .chatbot-close:hover {
      color: #fff;
      transform: rotate(90deg);
    }

    .chatbot-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .chatbot-message {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      animation: messageSlide 0.3s ease;
    }

    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .chatbot-message.user {
      flex-direction: row-reverse;
    }

    .chatbot-message.user .message-bubble {
      background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
      color: #fff;
      animation: messageSlide 0.3s ease;
      animation-direction: reverse;
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .message-avatar.ai {
      background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
    }

    .message-avatar.user {
      background: rgba(255, 255, 255, 0.1);
    }

    .message-bubble {
      background: rgba(255, 255, 255, 0.05);
      padding: 12px 16px;
      border-radius: 16px;
      max-width: 260px;
      word-wrap: break-word;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .chatbot-input-area {
      padding: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      gap: 12px;
    }

    .chatbot-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 12px 16px;
      color: #fff;
      font-size: 0.9rem;
      font-family: 'Inter', sans-serif;
      transition: all 0.3s;
    }

    .chatbot-input:focus {
      outline: none;
      border-color: #8b5cf6;
      background: rgba(255, 255, 255, 0.08);
    }

    .chatbot-send {
      background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .chatbot-send:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(139, 92, 246, 0.4);
    }

    .chatbot-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      width: fit-content;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: #8b5cf6;
      border-radius: 50%;
      animation: typingBounce 1.4s infinite;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typingBounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }

    .chat-suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }

    .suggestion-chip {
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid rgba(139, 92, 246, 0.3);
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      color: #a78bfa;
      cursor: pointer;
      transition: all 0.2s;
    }

    .suggestion-chip:hover {
      background: rgba(139, 92, 246, 0.2);
      border-color: rgba(139, 92, 246, 0.5);
      transform: translateY(-2px);
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .dashboard {
        grid-template-columns: 1fr;
      }
      .sidebar {
        border-right: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .two-col {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 600px) {
      .top-nav {
        padding: 12px 20px;
      }
      .logo h1 {
        font-size: 1.1rem;
      }
      .main-content {
        padding: 20px;
      }
      .chatbot-window {
        bottom: 90px;
        right: 10px;
        left: 10px;
        width: auto;
      }
      .chatbot-button {
        bottom: 20px;
        right: 20px;
      }
    }

    /* Incident Form Modal - Full Screen */
    .incident-form-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #0f0f14;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 1;
      transition: opacity 0.8s ease, transform 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .incident-form-overlay.hide {
      opacity: 0;
      transform: scale(0.95);
      pointer-events: none;
    }

    .incident-form-container {
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      background: rgba(20, 20, 28, 0.95);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 25px 70px rgba(0, 0, 0, 0.6);
      animation: slideInScale 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    @keyframes slideInScale {
      0% {
        opacity: 0;
        transform: translateY(50px) scale(0.9);
      }
      100% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .form-header {
      text-align: center;
      margin-bottom: 40px;
      position: relative;
      padding-top: 20px;
    }
    
    .form-header button:hover {
      background: rgba(139, 92, 246, 0.2) !important;
      border-color: rgba(139, 92, 246, 0.5) !important;
    }

    .form-header h1 {
      font-size: 2.5rem;
      margin-bottom: 12px;
      background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .form-header p {
      color: #71717a;
      font-size: 1rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }

    .form-group-full {
      grid-column: 1 / -1;
    }

    .form-group label {
      display: block;
      color: #a1a1aa;
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-group label .required {
      color: #ef4444;
    }

    .form-group input[type="text"],
    .form-group select {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: #fff;
      font-size: 0.95rem;
      font-family: 'Inter', sans-serif;
      transition: all 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #8b5cf6;
      background: rgba(139, 92, 246, 0.08);
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    .radio-group {
      display: flex;
      gap: 24px;
      margin-top: 8px;
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .radio-option input[type="radio"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #8b5cf6;
    }

    .radio-option label {
      margin: 0;
      cursor: pointer;
      text-transform: none;
      letter-spacing: normal;
    }

    .form-actions {
      display: flex;
      gap: 16px;
      margin-top: 32px;
    }

    .btn-form-submit {
      flex: 1;
      padding: 16px;
      background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
    }

    .btn-form-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(139, 92, 246, 0.6);
    }

    .section-divider {
      grid-column: 1 / -1;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.3), transparent);
      margin: 16px 0;
    }

    .section-title {
      grid-column: 1 / -1;
      color: #8b5cf6;
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 8px;
    }

    /* Page Transition */
    .page-transition {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
      opacity: 0;
    }

    .page-transition.active {
      display: flex;
      animation: transitionSlide 1.2s cubic-bezier(0.77, 0, 0.175, 1);
    }

    @keyframes transitionSlide {
      0% {
        opacity: 0;
        transform: translateX(-100%);
      }
      50% {
        opacity: 1;
        transform: translateX(0);
      }
      100% {
        opacity: 0;
        transform: translateX(100%);
      }
    }

    .transition-content {
      text-align: center;
      color: white;
    }

    .transition-content .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 24px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .transition-content h2 {
      font-size: 1.8rem;
      margin-bottom: 8px;
    }

    .transition-content p {
      font-size: 1rem;
      opacity: 0.9;
    }
    /* Fix for dark dropdowns */
    select, select option {
      background-color: #222 !important;
      color: #fff !important;
      border: 1px solid #444;
    }
    select:focus {
      outline: none;
      border-color: #8b5cf6;
    }
  </style>
</head>
<body>

<!-- Immediate script to hide form if viewing a report -->
<script>
(function() {
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('report_id')) {
    // Hide the form overlay and show loading screen immediately
    document.write('<style>#incidentFormOverlay { display: none !important; } #emptyState { display: none !important; } #reportLoadingScreen { display: flex !important; }</style>');
  }
})();
</script>

<!-- Report Loading Screen -->
<div id="reportLoadingScreen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #0f0f1a 100%); z-index: 9999; justify-content: center; align-items: center; flex-direction: column;">
  <div style="text-align: center;">
    <div style="width: 60px; height: 60px; border: 3px solid rgba(139, 92, 246, 0.2); border-top-color: #8b5cf6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 24px;"></div>
    <h2 style="color: #fff; font-size: 1.5rem; margin-bottom: 8px; font-family: system-ui, -apple-system, sans-serif;">Loading Report</h2>
    <p style="color: #71717a; font-size: 0.9rem; font-family: system-ui, -apple-system, sans-serif;">Fetching analysis data...</p>
  </div>
  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</div>

<!-- Back to Projects Button (shown when viewing a report) -->
<style>
  #backToProjectsBtn button:hover {
    background: rgba(139, 92, 246, 0.2) !important;
    border-color: rgba(139, 92, 246, 0.5) !important;
  }
</style>

<!-- Incident Form Modal (Shows on page load) -->
<div class="incident-form-overlay" id="incidentFormOverlay">
  <div class="incident-form-container">
    <div class="form-header">
      <button type="button" onclick="window.location.href='/projects'" style="position: absolute; top: 20px; left: 20px; display: flex; align-items: center; gap: 8px; padding: 8px 14px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; color: #a78bfa; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">
        <span>â†</span> Back to Projects
      </button>
      <h1>ðŸ§¬ Incident Analysis</h1>
      <p>Provide incident details before uploading logs</p>
    </div>

    <form id="incidentMetadataForm">
      <div class="form-grid">
        <div class="section-title">Incident Information</div>

        <div class="form-group form-group-full">
          <label>Incident Title <span class="required">*</span></label>
          <input type="text" id="incident_title" name="incident_title" 
                 placeholder="e.g., Database Timeout - Payment Service" required>
        </div>

        <div class="form-group">
          <label>System Name <span class="required">*</span></label>
          <input type="text" id="system_name" name="system_name" 
                 placeholder="e.g., payment-api" required>
        </div>

        <div class="form-group">
          <label>Owning Team <span class="required">*</span></label>
          <input type="text" id="owning_team" name="owning_team" 
                 placeholder="e.g., Platform Engineering" required>
        </div>

        <div class="form-group">
          <label>Environment <span class="required">*</span></label>
          <select id="environment" name="environment" required>
            <option value="">Select environment</option>
            <option value="prod">Production</option>
            <option value="staging">Staging</option>
          </select>
        </div>

        <div class="form-group">
          <label>Severity <span class="required">*</span></label>
          <select id="severity" name="severity" required>
            <option value="">Select severity</option>
            <option value="P1">P1 - Critical Outage</option>
            <option value="P2">P2 - Major Impact</option>
            <option value="P3">P3 - Minor Issue</option>
            <option value="P4">P4 - Low Priority</option>
          </select>
        </div>

        <div class="form-group">
          <label>Incident Type <span class="required">*</span></label>
          <select id="incident_type" name="incident_type" required>
            <option value="">Select type</option>
            <option value="Outage">Outage</option>
            <option value="Degradation">Degradation</option>
          </select>
        </div>

        <div class="section-divider"></div>
        <div class="section-title">Response Details</div>

        <div class="form-group">
          <label>Alert Triggered?</label>
          <div class="radio-group">
            <div class="radio-option">
              <input type="radio" id="alert_yes" name="alert_triggered" value="Yes" required>
              <label for="alert_yes">Yes</label>
            </div>
            <div class="radio-option">
              <input type="radio" id="alert_no" name="alert_triggered" value="No">
              <label for="alert_no">No</label>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Manual Intervention?</label>
          <div class="radio-group">
            <div class="radio-option">
              <input type="radio" id="manual_yes" name="manual_intervention" value="Yes" required>
              <label for="manual_yes">Yes</label>
            </div>
            <div class="radio-option">
              <input type="radio" id="manual_no" name="manual_intervention" value="No">
              <label for="manual_no">No</label>
            </div>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-form-submit">
          Continue to Upload Logs â†’
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Page Transition Animation -->
<div class="page-transition" id="pageTransition">
  <div class="transition-content">
    <div class="spinner"></div>
    <h2>Preparing Analysis Dashboard</h2>
    <p>Loading incident workspace...</p>
  </div>
</div>

<!-- Top Navigation -->
<nav class="top-nav">
  <div class="logo" onclick="window.location.href='/projects'" style="cursor: pointer;">
    <h1>Sys<span>Autopsy</span></h1>
  </div>
  <div class="nav-center">
    <div class="project-badge" id="projectBadge" onclick="window.location.href='/projects'">
      <span class="project-icon">ðŸ“Š</span>
      <span id="currentProjectName">Loading...</span>
      <span class="change-project">Change</span>
    </div>
  </div>
  <div class="nav-right">
    <div class="nav-status">
      <div class="status-dot"></div>
      System Ready
    </div>
    <div class="user-menu">
      <span id="userName">User</span>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>
</nav>

<style>
  .nav-center {
    display: flex;
    align-items: center;
  }
  .project-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: rgba(139, 92, 246, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .project-badge:hover {
    background: rgba(139, 92, 246, 0.2);
    border-color: rgba(139, 92, 246, 0.5);
  }
  .project-badge .project-icon {
    font-size: 1rem;
  }
  .project-badge .change-project {
    font-size: 0.7rem;
    color: #8b5cf6;
    margin-left: 8px;
  }
  .nav-right {
    display: flex;
    align-items: center;
    gap: 20px;
  }
  .user-menu {
    display: flex;
    align-items: center;
    gap: 12px;
    color: #a1a1aa;
    font-size: 0.9rem;
  }
  .logout-btn {
    padding: 6px 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    background: transparent;
    color: #a1a1aa;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .logout-btn:hover {
    border-color: #ef4444;
    color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
  }
  .historical-context-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid rgba(34, 197, 94, 0.3);
    border-radius: 12px;
    font-size: 0.75rem;
    color: #4ade80;
    margin-top: 8px;
  }
</style>

<div class="dashboard">
  <!-- Sidebar -->
  <aside class="sidebar">
    <!-- Back to Projects section (shown when viewing a report) -->
    <div class="sidebar-section" id="backToProjectsSection" style="display: none;">
      <button onclick="window.location.href='/projects'" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 16px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; color: #a78bfa; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; font-family: system-ui, -apple-system, sans-serif;">
        <span>â†</span> Back to Projects
      </button>
    </div>
    
    <div class="sidebar-section" id="uploadSection">
      <h4>Upload Log File</h4>
      <div class="upload-card">
        <div class="upload-zone" id="dropZone" onclick="document.getElementById('logfile').click()">
          <div class="upload-icon">â¬†</div>
          <h3>Drop log file here</h3>
          <p>or click to browse â€¢ CSV format</p>
          <div class="file-name" id="fileName"></div>
        </div>
        <input type="file" id="logfile" accept=".csv">
        <button class="btn btn-primary" onclick="analyze()">
          Run Forensic Analysis
        </button>
      </div>
    </div>

    <div class="sidebar-section">
      <h4>History</h4>
      <button class="btn btn-secondary" onclick="loadPastReports()">
        Load Past Reports
      </button>
      <div class="past-reports-list" id="pastReports">
        <div style="margin-top: 16px;" id="reportList"></div>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Loading State -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>Performing forensic analysis...</p>
    </div>

    <!-- Empty State -->
    <div class="empty-state" id="emptyState">
      <div class="empty-state-icon">â—‹</div>
      <h3>No Analysis Yet</h3>
      <p>Upload a log file to begin forensic investigation</p>
    </div>

    <!-- Results -->
    <div id="result">
      <!-- Incident Metadata Card -->
      <div class="incident-metadata-card" id="incidentMetadata" style="display: none;">
        <h3>ðŸ“‹ Incident Overview</h3>
        <div class="metadata-grid">
          <div class="metadata-item">
            <span class="metadata-label">Title</span>
            <span class="metadata-value" id="meta_title">â€”</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">System</span>
            <span class="metadata-value" id="meta_system">â€”</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Environment</span>
            <span class="metadata-badge" id="meta_env">â€”</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Severity</span>
            <span class="metadata-badge severity" id="meta_severity">â€”</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Type</span>
            <span class="metadata-value" id="meta_type">â€”</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Team</span>
            <span class="metadata-value" id="meta_team">â€”</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Alert Triggered</span>
            <span class="metadata-badge" id="meta_alert">â€”</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Manual Intervention</span>
            <span class="metadata-badge" id="meta_manual">â€”</span>
          </div>
        </div>
      </div>

      <!-- AI Adaptive Analysis Card -->
      <div class="adaptive-analysis-card" id="adaptiveAnalysis" style="display: none;">
        <h3>AI Adaptive Analysis</h3>
        <ul class="adaptive-explanation" id="adaptiveExplanation"></ul>
        <div class="adaptive-stats">
          <div class="adaptive-stat">
            <span class="adaptive-stat-label">Risk Level</span>
            <span class="adaptive-stat-value" id="aiRiskLevel">â€”</span>
          </div>
          <div class="adaptive-stat">
            <span class="adaptive-stat-label">Similar Incidents</span>
            <span class="adaptive-stat-value" id="aiSimilarCount">â€”</span>
          </div>
          <div class="adaptive-stat">
            <span class="adaptive-stat-label">Dynamic Threshold</span>
            <span class="adaptive-stat-value" id="aiThreshold">â€”</span>
          </div>
        </div>
        <div class="similar-incidents" id="similarIncidents"></div>
      </div>

      <!-- AI Similarity Visualization -->
      <div class="similarity-box" id="similarityBox" style="display: none;">
        <h3>AI Similarity Insights</h3>
        <p id="similarityText"></p>
        <div class="similarity-bar">
          <div class="similarity-fill" id="similarityFill"></div>
          <span class="similarity-percentage" id="similarityPercentage">0%</span>
        </div>
      </div>

      <!-- GenAI Explanation -->
      <div class="genai-explanation-card" id="genaiExplanation" style="display: none;">
        <h3>AI-Generated Incident Summary</h3>
        <div class="genai-content" id="genaiContent"></div>
      </div>

      <!-- Risk Warning Card -->
      <div class="risk-warning-card" id="riskWarning">
        <h3>Pre-Incident Risk Warning</h3>
        <p id="riskText"></p>
        <span class="similarity-badge" id="riskSimilarity"></span>
      </div>

      <!-- Stats Row -->
      <div class="stats-grid">
        <div class="stat-card critical" id="topCauseCard">
          <div class="stat-card-header">
            <span class="stat-card-label">Primary Root Cause</span>
          </div>
          <div class="stat-card-value" id="topCauseText">â€”</div>
          <div class="stat-card-sub">Highest probability factor</div>
        </div>

        <div class="stat-card warning">
          <div class="stat-card-header">
            <span class="stat-card-label">Preventability</span>
          </div>
          <div class="stat-card-value" id="pmPreventStat">â€”</div>
          <div class="stat-card-sub">Could this be avoided?</div>
        </div>

        <div class="stat-card info">
          <div class="stat-card-header">
            <span class="stat-card-label">Events Analyzed</span>
          </div>
          <div class="stat-card-value" id="eventCount">â€”</div>
          <div class="stat-card-sub">Timeline entries processed</div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="charts-grid">
        <div class="chart-card">
          <div class="card-header">
            <h3>Root Cause Distribution</h3>
          </div>
          <div class="chart-container">
            <canvas id="causesPieChart"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <div class="card-header">
            <h3>Event Severity Breakdown</h3>
          </div>
          <div class="chart-container">
            <canvas id="severityChart"></canvas>
          </div>
          <div class="severity-legend">
            <div class="legend-item"><div class="legend-dot critical"></div> Critical</div>
            <div class="legend-item"><div class="legend-dot warning"></div> Warning</div>
            <div class="legend-item"><div class="legend-dot info"></div> Info</div>
          </div>
        </div>
      </div>

      <!-- Risk Score Card -->
      <div class="charts-grid" style="grid-template-columns: 1fr;">
        <div class="chart-card">
          <div class="card-header">
            <h3>Risk Score</h3>
          </div>
          <div class="chart-container">
            <div class="gauge-container">
              <canvas id="riskGauge"></canvas>
              <div class="gauge-value" id="riskValue">--</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Two Column: Intervention + Postmortem -->
      <div class="two-col">
        <div class="card intervention-card" id="interventionCard" style="display:none;">
          <div class="card-header">
            <h3>Missed Intervention Point</h3>
          </div>
          <div class="card-body">
            <p class="intervention-text" id="interventionText"></p>
          </div>
        </div>

        <div class="card postmortem-card" id="postmortemCard">
          <div class="card-header">
            <h3>Postmortem Summary</h3>
            <button class="btn btn-download" onclick="downloadReport()">
              Download
            </button>
          </div>
          <div class="card-body">
            <ul class="postmortem-list">
              <li><b>Primary Cause</b> <span id="pmCause">â€”</span></li>
              <li><b>Preventability</b> <span id="pmPrevent">â€”</span></li>
              <li><b>Recommended Action</b> <span id="pmAction">â€”</span></li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Two Column: Timeline + Causes -->
      <div class="two-col">
        <div class="card">
          <div class="card-header">
            <h3>Failure Timeline</h3>
          </div>
          <div class="card-body">
            <div id="timeline"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3>Root Cause Analysis</h3>
          </div>
          <div class="card-body" id="causes"></div>
        </div>
      </div>

      <!-- Explanation -->
      <div class="card">
        <div class="card-header">
          <h3>Detailed Explanation</h3>
        </div>
        <div class="card-body">
          <ul class="explanation-list" id="explanation"></ul>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
  let latestReport = null;
  let pieChart = null;
  let severityChart = null;
  let gaugeChart = null;

  // Chart.js default styling for dark theme
  Chart.defaults.color = '#a1a1aa';
  Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.06)';

  // File upload handling
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('logfile');
  const fileNameDisplay = document.getElementById('fileName');

  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
    dropZone.addEventListener(event, e => {
      e.preventDefault();
      e.stopPropagation();
    });
  });

  ['dragenter', 'dragover'].forEach(event => {
    dropZone.addEventListener(event, () => dropZone.classList.add('dragover'));
  });

  ['dragleave', 'drop'].forEach(event => {
    dropZone.addEventListener(event, () => dropZone.classList.remove('dragover'));
  });

  dropZone.addEventListener('drop', e => {
    const files = e.dataTransfer.files;
    if (files.length) {
      fileInput.files = files;
      showFileName(files[0].name);
    }
  });

  fileInput.addEventListener('change', e => {
    if (e.target.files.length) {
      showFileName(e.target.files[0].name);
    }
  });

  function showFileName(name) {
    fileNameDisplay.textContent = name;
    fileNameDisplay.style.display = 'inline-block';
  }

function analyze() {
  const fileInput = document.getElementById("logfile");
  
  if (!fileInput.files.length) {
    alert("Please select a log file first.");
    return;
  }

  // Show loading, hide empty state
  document.getElementById("loading").classList.add("active");
  document.getElementById("emptyState").style.display = "none";
  document.getElementById("result").style.display = "none";

  const formData = new FormData();
  formData.append("logfile", fileInput.files[0]);

  fetch("/analyze", {
    method: "POST",
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    // Hide loading
    document.getElementById("loading").classList.remove("active");
    
    latestReport = data;

    // Display incident metadata
    if (data.metadata) {
      const metaCard = document.getElementById("incidentMetadata");
      metaCard.style.display = "block";
      
      document.getElementById("meta_title").textContent = data.metadata.incident_title;
      document.getElementById("meta_system").textContent = data.metadata.system_name;
      document.getElementById("meta_type").textContent = data.metadata.incident_type;
      document.getElementById("meta_team").textContent = data.metadata.owning_team;
      
      // Environment badge
      const envBadge = document.getElementById("meta_env");
      envBadge.textContent = data.metadata.environment.toUpperCase();
      envBadge.setAttribute('data-env', data.metadata.environment);
      
      // Severity badge
      const sevBadge = document.getElementById("meta_severity");
      sevBadge.textContent = data.metadata.severity;
      sevBadge.setAttribute('data-severity', data.metadata.severity);
      
      // Alert badge
      const alertBadge = document.getElementById("meta_alert");
      alertBadge.textContent = data.metadata.alert_triggered;
      alertBadge.setAttribute('data-value', data.metadata.alert_triggered);
      
      // Manual intervention badge
      const manualBadge = document.getElementById("meta_manual");
      manualBadge.textContent = data.metadata.manual_intervention;
      manualBadge.setAttribute('data-value', data.metadata.manual_intervention);
    }

    // Display risk warning if present
    if (data.risk_warning) {
      const riskCard = document.getElementById("riskWarning");
      riskCard.style.display = "block";
      document.getElementById("riskText").innerText = data.risk_warning.message;
      document.getElementById("riskSimilarity").innerText = `Similarity: ${data.risk_warning.similarity}% match with past failure`;
    } else {
      document.getElementById("riskWarning").style.display = "none";
    }

    // Highlight top root cause
    const probabilities = data.probabilities;
    let topCause = "";
    let maxValue = -1;

    for (let cause in probabilities) {
      if (probabilities[cause] > maxValue) {
        maxValue = probabilities[cause];
        topCause = cause;
      }
    }

    // Update stats cards
    document.getElementById("topCauseText").innerText = `${topCause} (${maxValue}%)`;
    document.getElementById("pmPreventStat").innerText = data.postmortem_summary.preventability;
    document.getElementById("eventCount").innerText = data.timeline.length;

    // Missed Intervention Detection
    if (data.missed_intervention) {
      document.getElementById("interventionCard").style.display = "block";
      document.getElementById("interventionText").innerText = data.missed_intervention.message;
      // Adjust grid for intervention card
      document.querySelector('.two-col').style.gridTemplateColumns = '1fr 1fr';
    } else {
      document.getElementById("interventionCard").style.display = "none";
      document.getElementById("postmortemCard").style.gridColumn = 'span 2';
    }

    // Automated Postmortem Summary
    document.getElementById("pmCause").innerText = data.postmortem_summary.primary_cause;
    document.getElementById("pmPrevent").innerText = data.postmortem_summary.preventability;
    document.getElementById("pmAction").innerText = data.postmortem_summary.recommended_action;

    document.getElementById("result").style.display = "block";

    // Timeline with severity styling and scroll animation
    const timeline = document.getElementById("timeline");
    timeline.innerHTML = "";
    
    // Store timeline data globally for pagination
    window.timelineData = data.timeline;
    window.timelineCurrentIndex = 0;
    window.timelineItemsPerPage = 10;
    
    // Render initial timeline items
    renderTimelineItems();

    // Initialize scroll-triggered timeline animations
    initTimelineScrollAnimation();

    // Causes with visual bars
    const causes = document.getElementById("causes");
    causes.innerHTML = "";
    for (let c in data.probabilities) {
      const div = document.createElement("div");
      div.className = "cause-item";
      div.innerHTML = `
        <div class="cause-header">
          <span class="cause-name">${c}</span>
          <span class="cause-percent">${data.probabilities[c]}%</span>
        </div>
        <div class="cause-bar-bg">
          <div class="cause-bar-fill" style="width: ${data.probabilities[c]}%"></div>
        </div>
      `;
      causes.appendChild(div);
    }

    // Explanations
    const explanation = document.getElementById("explanation");
    explanation.innerHTML = "";
    for (let e in data.explanations) {
      const li = document.createElement("li");
      li.innerHTML = `<b>${e}</b>${data.explanations[e]}`;
      explanation.appendChild(li);
    }

    // Render Charts
    renderCharts(data);
  })
  .catch(err => {
    document.getElementById("loading").classList.remove("active");
    document.getElementById("emptyState").style.display = "block";
    alert("Error analyzing file. Please try again.");
  });
}

// Chart rendering function
function renderCharts(data) {
  const probabilities = data.probabilities;
  const causeLabels = Object.keys(probabilities);
  const causeValues = Object.values(probabilities);
  
  // Color palette
  const colors = {
    primary: ['#8b5cf6', '#6366f1', '#a78bfa', '#818cf8', '#c4b5fd'],
    severity: {
      critical: '#ef4444',
      warning: '#f59e0b',
      info: '#3b82f6'
    }
  };

  // Destroy existing charts if they exist
  if (pieChart) pieChart.destroy();
  if (severityChart) severityChart.destroy();
  if (gaugeChart) gaugeChart.destroy();

  // 1. Pie Chart - Root Cause Distribution
  const pieCtx = document.getElementById('causesPieChart').getContext('2d');
  pieChart = new Chart(pieCtx, {
    type: 'doughnut',
    data: {
      labels: causeLabels,
      datasets: [{
        data: causeValues,
        backgroundColor: colors.primary,
        borderColor: '#0f0f14',
        borderWidth: 3,
        hoverOffset: 10
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '65%',
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 20,
            usePointStyle: true,
            pointStyle: 'circle',
            font: { size: 11, family: 'Inter' }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(20, 20, 28, 0.95)',
          titleFont: { family: 'Inter', weight: '600' },
          bodyFont: { family: 'JetBrains Mono' },
          padding: 12,
          cornerRadius: 8,
          callbacks: {
            label: (ctx) => ` ${ctx.parsed}%`
          }
        }
      }
    }
  });

  // 2. Severity Chart - Event Severity Breakdown
  let criticalCount = 0, warningCount = 0, infoCount = 0;
  data.timeline.forEach(t => {
    if (t.includes('CRITICAL')) criticalCount++;
    else if (t.includes('WARNING')) warningCount++;
    else infoCount++;
  });

  const severityCtx = document.getElementById('severityChart').getContext('2d');
  severityChart = new Chart(severityCtx, {
    type: 'polarArea',
    data: {
      labels: ['Critical', 'Warning', 'Info'],
      datasets: [{
        data: [criticalCount, warningCount, infoCount],
        backgroundColor: [
          'rgba(239, 68, 68, 0.7)',
          'rgba(245, 158, 11, 0.7)',
          'rgba(59, 130, 246, 0.7)'
        ],
        borderColor: [
          '#ef4444',
          '#f59e0b',
          '#3b82f6'
        ],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        r: {
          beginAtZero: true,
          ticks: { display: false },
          grid: { color: 'rgba(255, 255, 255, 0.08)' }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(20, 20, 28, 0.95)',
          titleFont: { family: 'Inter', weight: '600' },
          bodyFont: { family: 'JetBrains Mono' },
          padding: 12,
          cornerRadius: 8,
          callbacks: {
            label: (ctx) => ` ${ctx.parsed.r} events`
          }
        }
      }
    }
  });

  // 4. Risk Gauge
  const maxProb = Math.max(...causeValues);
  const riskScore = Math.round(maxProb);
  document.getElementById('riskValue').textContent = riskScore + '%';

  const gaugeCtx = document.getElementById('riskGauge').getContext('2d');
  
  // Determine color based on risk
  let riskColor;
  if (riskScore >= 60) riskColor = '#ef4444';
  else if (riskScore >= 40) riskColor = '#f59e0b';
  else riskColor = '#22c55e';

  gaugeChart = new Chart(gaugeCtx, {
    type: 'doughnut',
    data: {
      datasets: [{
        data: [riskScore, 100 - riskScore],
        backgroundColor: [riskColor, 'rgba(255, 255, 255, 0.05)'],
        borderWidth: 0,
        circumference: 270,
        rotation: 225
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '80%',
      plugins: {
        legend: { display: false },
        tooltip: { enabled: false }
      }
    }
  });
}

function downloadReport() {
  if (!latestReport) {
    alert("No report available to download.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  const pageWidth = doc.internal.pageSize.getWidth();
  let y = 20;
  
  // Header
  doc.setFillColor(139, 92, 246);
  doc.rect(0, 0, pageWidth, 35, 'F');
  
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(24);
  doc.setFont('helvetica', 'bold');
  doc.text('SysAutopsy', 20, 22);
  
  doc.setFontSize(10);
  doc.setFont('helvetica', 'normal');
  doc.text('Digital Forensics Report', 20, 30);
  
  doc.setFontSize(9);
  doc.text(`Generated: ${new Date().toLocaleString()}`, pageWidth - 20, 22, { align: 'right' });
  
  y = 50;
  
  // Primary Root Cause Section
  doc.setTextColor(220, 38, 38);
  doc.setFontSize(12);
  doc.setFont('helvetica', 'bold');
  doc.text('PRIMARY ROOT CAUSE', 20, y);
  y += 8;
  
  doc.setTextColor(40, 40, 40);
  doc.setFontSize(16);
  const topCause = Object.entries(latestReport.probabilities).reduce((a, b) => a[1] > b[1] ? a : b);
  doc.text(`${topCause[0]} (${topCause[1]}%)`, 20, y);
  y += 15;
  
  // Postmortem Summary
  doc.setFillColor(240, 245, 255);
  doc.rect(15, y - 5, pageWidth - 30, 45, 'F');
  
  doc.setTextColor(37, 99, 235);
  doc.setFontSize(12);
  doc.setFont('helvetica', 'bold');
  doc.text('POSTMORTEM SUMMARY', 20, y + 5);
  
  doc.setTextColor(60, 60, 60);
  doc.setFontSize(10);
  doc.setFont('helvetica', 'normal');
  y += 15;
  doc.text(`Primary Cause: ${latestReport.postmortem_summary.primary_cause}`, 25, y);
  y += 8;
  doc.text(`Preventability: ${latestReport.postmortem_summary.preventability}`, 25, y);
  y += 8;
  doc.text(`Recommended Action: ${latestReport.postmortem_summary.recommended_action}`, 25, y);
  y += 20;
  
  // Missed Intervention (if exists)
  if (latestReport.missed_intervention) {
    doc.setFillColor(255, 250, 230);
    doc.rect(15, y - 5, pageWidth - 30, 25, 'F');
    
    doc.setTextColor(217, 119, 6);
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('MISSED INTERVENTION POINT', 20, y + 5);
    
    doc.setTextColor(60, 60, 60);
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    const interventionText = doc.splitTextToSize(latestReport.missed_intervention.message, pageWidth - 50);
    doc.text(interventionText, 25, y + 14);
    y += 30;
  }
  
  y += 5;
  
  // Root Cause Analysis
  doc.setTextColor(99, 102, 241);
  doc.setFontSize(12);
  doc.setFont('helvetica', 'bold');
  doc.text('ROOT CAUSE ANALYSIS', 20, y);
  y += 10;
  
  doc.setTextColor(60, 60, 60);
  doc.setFontSize(10);
  doc.setFont('helvetica', 'normal');
  
  for (let cause in latestReport.probabilities) {
    const prob = latestReport.probabilities[cause];
    
    // Draw progress bar background
    doc.setFillColor(230, 230, 240);
    doc.rect(25, y - 3, 100, 6, 'F');
    
    // Draw progress bar fill
    doc.setFillColor(139, 92, 246);
    doc.rect(25, y - 3, prob, 6, 'F');
    
    doc.setTextColor(60, 60, 60);
    doc.text(cause, 25, y + 10);
    doc.text(`${prob}%`, 130, y);
    y += 18;
  }
  
  y += 5;
  
  // Timeline
  doc.setTextColor(99, 102, 241);
  doc.setFontSize(12);
  doc.setFont('helvetica', 'bold');
  doc.text('FAILURE TIMELINE', 20, y);
  y += 10;
  
  doc.setFontSize(9);
  doc.setFont('helvetica', 'normal');
  
  latestReport.timeline.forEach((event, index) => {
    if (y > 270) {
      doc.addPage();
      y = 20;
    }
    
    // Timeline dot
    if (event.includes('CRITICAL')) {
      doc.setFillColor(239, 68, 68);
    } else if (event.includes('WARNING')) {
      doc.setFillColor(245, 158, 11);
    } else {
      doc.setFillColor(59, 130, 246);
    }
    doc.circle(22, y - 1, 2, 'F');
    
    doc.setTextColor(80, 80, 80);
    const eventText = doc.splitTextToSize(event, pageWidth - 50);
    doc.text(eventText, 28, y);
    y += eventText.length * 5 + 5;
  });
  
  y += 5;
  
  // Explanations
  if (y > 240) {
    doc.addPage();
    y = 20;
  }
  
  doc.setTextColor(99, 102, 241);
  doc.setFontSize(12);
  doc.setFont('helvetica', 'bold');
  doc.text('DETAILED EXPLANATIONS', 20, y);
  y += 10;
  
  doc.setFontSize(9);
  doc.setFont('helvetica', 'normal');
  
  for (let exp in latestReport.explanations) {
    if (y > 270) {
      doc.addPage();
      y = 20;
    }
    
    doc.setTextColor(99, 102, 241);
    doc.setFont('helvetica', 'bold');
    doc.text(`${exp}:`, 25, y);
    
    doc.setTextColor(80, 80, 80);
    doc.setFont('helvetica', 'normal');
    const expText = doc.splitTextToSize(latestReport.explanations[exp], pageWidth - 55);
    doc.text(expText, 25, y + 6);
    y += expText.length * 5 + 12;
  }
  
  // Footer
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setTextColor(150, 150, 150);
    doc.text(
      `SysAutopsy Forensic Report | Page ${i} of ${pageCount}`,
      pageWidth / 2,
      doc.internal.pageSize.getHeight() - 10,
      { align: 'center' }
    );
  }
  
  doc.save('sysautopsy_forensic_report.pdf');
}

function loadPastReports() {
  fetch("/past-reports")
    .then(res => {
      if (res.status === 401) {
        window.location.href = '/login';
        return [];
      }
      return res.json();
    })
    .then(data => {
      // Store data globally for pagination
      window.allReports = data;
      window.currentPage = 1;
      window.reportsPerPage = 10;
      
      renderReportsPage();
    })
    .catch(err => {
      console.error('Failed to load reports:', err);
      document.getElementById("reportList").innerHTML = 
        '<div class="past-report-item"><span>Failed to load reports</span></div>';
    });
}

function renderReportsPage() {
  const data = window.allReports || [];
  const currentPage = window.currentPage || 1;
  const perPage = window.reportsPerPage || 10;
  const totalPages = Math.ceil(data.length / perPage);
  
  const container = document.getElementById("pastReports");
  container.classList.add("active");

  const list = document.getElementById("reportList");
  list.innerHTML = "";

  if (data.length === 0) {
    list.innerHTML = '<div class="past-report-item"><span>No past reports found</span></div>';
    return;
  }

  // Calculate slice indices (show most recent first)
  const reversedData = [...data].reverse();
  const startIdx = (currentPage - 1) * perPage;
  const endIdx = Math.min(startIdx + perPage, data.length);
  const reportsToShow = reversedData.slice(startIdx, endIdx);

  reportsToShow.forEach((report, index) => {
    const originalIndex = data.length - startIdx - index;
    const topCause = report.primary_root_cause || Object.keys(report.probabilities || {})[0] || 'Unknown';
    const title = report.metadata?.incident_title || `Report #${originalIndex}`;
    const date = report.created_at ? new Date(report.created_at).toLocaleDateString() : '';
    const div = document.createElement("div");
    div.className = "past-report-item";
    div.innerHTML = `
      <strong>${title}</strong>
      <span>${topCause}${date ? ' â€¢ ' + date : ''}</span>
    `;
    list.appendChild(div);
  });

  // Add pagination controls if more than one page
  if (totalPages > 1) {
    const paginationDiv = document.createElement("div");
    paginationDiv.className = "pagination-controls";
    paginationDiv.innerHTML = `
      <button class="pagination-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
        â† Prev
      </button>
      <span class="pagination-info">${currentPage} / ${totalPages}</span>
      <button class="pagination-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
        Next â†’
      </button>
    `;
    list.appendChild(paginationDiv);
  }
}

function goToPage(page) {
  const totalPages = Math.ceil((window.allReports || []).length / (window.reportsPerPage || 10));
  if (page >= 1 && page <= totalPages) {
    window.currentPage = page;
    renderReportsPage();
  }
}

// Render timeline items with pagination
function renderTimelineItems(showAll = false) {
  const timeline = document.getElementById("timeline");
  const data = window.timelineData || [];
  const currentIndex = window.timelineCurrentIndex || 0;
  const itemsPerPage = window.timelineItemsPerPage || 10;
  
  if (showAll) {
    // Show all remaining items
    window.timelineCurrentIndex = data.length;
  } else {
    // Show next batch
    window.timelineCurrentIndex = Math.min(currentIndex + itemsPerPage, data.length);
  }
  
  // Clear existing items and controls
  timeline.innerHTML = "";
  
  // Create list for timeline items
  const list = document.createElement("ul");
  list.className = "timeline-list";
  list.id = "timelineList";
  
  // Add items up to current index
  for (let i = 0; i < window.timelineCurrentIndex; i++) {
    const t = data[i];
    const li = document.createElement("li");
    li.textContent = t;
    if (t.includes("CRITICAL")) li.className = "critical";
    else if (t.includes("WARNING")) li.className = "warning";
    else li.className = "info";
    list.appendChild(li);
  }
  
  timeline.appendChild(list);
  
  // Add controls if there are more items
  if (window.timelineCurrentIndex < data.length) {
    const controls = document.createElement("div");
    controls.className = "timeline-controls";
    controls.innerHTML = `
      <div class="timeline-count">Showing ${window.timelineCurrentIndex} of ${data.length} events</div>
      <button class="btn-show-more" onclick="showMoreTimeline()">
        <span>Show More</span>
        <span>â†“</span>
      </button>
      <button class="btn-show-more" onclick="showAllTimeline()" style="margin-left: 8px;">
        <span>Show All</span>
      </button>
    `;
    timeline.appendChild(controls);
  } else if (data.length > itemsPerPage) {
    // Show completion message
    const controls = document.createElement("div");
    controls.className = "timeline-controls";
    controls.innerHTML = `
      <div class="timeline-count">All ${data.length} events displayed</div>
    `;
    timeline.appendChild(controls);
  }
  
  // Re-initialize scroll animations for new items
  setTimeout(() => {
    initTimelineScrollAnimation();
  }, 100);
}

function showMoreTimeline() {
  renderTimelineItems(false);
}

function showAllTimeline() {
  renderTimelineItems(true);
}

// Scroll-triggered timeline animation function
function initTimelineScrollAnimation() {
  const timelineItems = document.querySelectorAll('.timeline-list li');
  
  // Create Intersection Observer
  const observerOptions = {
    root: null,
    rootMargin: '0px',
    threshold: 0.1
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry, index) => {
      if (entry.isIntersecting) {
        // Add delay based on item position for staggered effect
        const items = Array.from(timelineItems);
        const itemIndex = items.indexOf(entry.target);
        
        setTimeout(() => {
          entry.target.classList.add('visible');
        }, itemIndex * 100); // 100ms delay between each item
        
        // Unobserve after animation
        observer.unobserve(entry.target);
      }
    });
  }, observerOptions);

  // Observe all timeline items
  timelineItems.forEach(item => {
    observer.observe(item);
  });
}

// Incident Form Handling
let incidentMetadata = null;

document.getElementById('incidentMetadataForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  // Collect form data
  const formData = new FormData(this);
  incidentMetadata = {
    incident_title: formData.get('incident_title'),
    system_name: formData.get('system_name'),
    environment: formData.get('environment'),
    severity: formData.get('severity'),
    incident_type: formData.get('incident_type'),
    owning_team: formData.get('owning_team'),
    alert_triggered: formData.get('alert_triggered'),
    manual_intervention: formData.get('manual_intervention')
  };
  
  // Trigger cool transition
  const overlay = document.getElementById('incidentFormOverlay');
  const transition = document.getElementById('pageTransition');
  
  // Show transition
  transition.classList.add('active');
  
  // Hide form after transition starts
  setTimeout(() => {
    overlay.classList.add('hide');
  }, 200);
  
  // Remove transition and show dashboard
  setTimeout(() => {
    transition.classList.remove('active');
    overlay.style.display = 'none';
    
    // Show success message
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(139, 92, 246, 0.5);
      z-index: 1000;
      animation: slideInBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      font-weight: 500;
    `;
    notification.innerHTML = `âœ… Incident metadata saved! Upload logs to continue.`;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.style.opacity = '0';
      notification.style.transform = 'translateY(-20px)';
      notification.style.transition = 'all 0.4s';
      setTimeout(() => notification.remove(), 400);
    }, 3000);
  }, 1200);
});

// Enhanced analyze function with metadata
async function analyzeWithMetadata() {
  if (!incidentMetadata) {
    alert('Please complete the incident form first!');
    return;
  }
  
  const fileInput = document.getElementById("logfile");
  if (!fileInput.files.length) {
    alert("Please select a log file to analyze.");
    return;
  }

  // Show loading, hide empty state
  document.getElementById("loading").classList.add("active");
  document.getElementById("emptyState").style.display = "none";
  document.getElementById("result").style.display = "none";

  const formData = new FormData();
  formData.append("file", fileInput.files[0]);
  
  // Add metadata to form
  Object.keys(incidentMetadata).forEach(key => {
    formData.append(key, incidentMetadata[key]);
  });

  try {
    const response = await fetch("/analyze", {
      method: "POST",
      body: formData
    });

    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

    const data = await response.json();
    
    // Hide loading
    document.getElementById("loading").classList.remove("active");
    
    latestReport = data;

    // Display metadata if present
    if (data.metadata) {
      const metaCard = document.getElementById("incidentMetadata");
      metaCard.style.display = "block";
      document.getElementById("meta_title").textContent = data.metadata.incident_title || "â€”";
      document.getElementById("meta_system").textContent = data.metadata.system_name || "â€”";
      
      const envBadge = document.getElementById("meta_env");
      envBadge.textContent = data.metadata.environment || "â€”";
      envBadge.setAttribute("data-env", data.metadata.environment);
      
      const sevBadge = document.getElementById("meta_severity");
      sevBadge.textContent = data.metadata.severity || "â€”";
      sevBadge.setAttribute("data-severity", data.metadata.severity);
      
      document.getElementById("meta_type").textContent = data.metadata.incident_type || "â€”";
      document.getElementById("meta_team").textContent = data.metadata.owning_team || "â€”";
      
      const alertBadge = document.getElementById("meta_alert");
      alertBadge.textContent = data.metadata.alert_triggered || "â€”";
      alertBadge.setAttribute("data-value", data.metadata.alert_triggered);
      
      const manualBadge = document.getElementById("meta_manual");
      manualBadge.textContent = data.metadata.manual_intervention || "â€”";
      manualBadge.setAttribute("data-value", data.metadata.manual_intervention);
    }

    // Display AI Adaptive Analysis
    if (data.adaptive_analysis) {
      const aiCard = document.getElementById("adaptiveAnalysis");
      aiCard.style.display = "block";
      
      const adaptive = data.adaptive_analysis;
      
      // Explanation as bullet list
      const explanationList = document.getElementById("adaptiveExplanation");
      explanationList.innerHTML = "";
      if (Array.isArray(adaptive.explanation)) {
        adaptive.explanation.forEach(point => {
          const li = document.createElement("li");
          li.textContent = point;
          explanationList.appendChild(li);
        });
      }
      
      // Risk Level
      const riskLevel = document.getElementById("aiRiskLevel");
      riskLevel.textContent = adaptive.risk_level;
      riskLevel.className = `adaptive-stat-value risk-${adaptive.risk_level}`;
      
      // Similar Incidents Count
      document.getElementById("aiSimilarCount").textContent = adaptive.similar_incidents_found || "0";
      
      // Dynamic Threshold
      const thresholds = adaptive.dynamic_thresholds_used;
      document.getElementById("aiThreshold").textContent = 
        `${thresholds.alert_ignore} min`;
      
      // Similar Incidents List
      const similarDiv = document.getElementById("similarIncidents");
      similarDiv.innerHTML = "";
      
      if (adaptive.similar_incidents && adaptive.similar_incidents.length > 0) {
        const title = document.createElement("h4");
        title.style.cssText = "color: #9ca3af; font-size: 0.85rem; margin-bottom: 12px; font-weight: 600;";
        title.textContent = "SIMILAR HISTORICAL INCIDENTS:";
        similarDiv.appendChild(title);
        
        adaptive.similar_incidents.forEach(incident => {
          const item = document.createElement("div");
          item.className = "similar-incident-item";
          item.innerHTML = `
            <span class="similar-incident-cause">${incident.root_cause}</span>
            <span class="similar-incident-match">${incident.similarity}% match</span>
          `;
          similarDiv.appendChild(item);
        });
      }
      
      // Display project historical context
      if (adaptive.project_context_applied) {
        const contextDiv = document.createElement("div");
        contextDiv.className = "project-context-section";
        contextDiv.style.cssText = "margin-top: 16px; padding: 12px; background: rgba(34, 197, 94, 0.05); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 8px;";
        contextDiv.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span style="font-size: 1rem;">ðŸ“Š</span>
            <span style="color: #4ade80; font-size: 0.85rem; font-weight: 600;">Project Context Applied</span>
          </div>
          <p style="color: #a1a1aa; font-size: 0.8rem; margin: 0;">Analysis enhanced with patterns from previous logs in this project.</p>
        `;
        similarDiv.appendChild(contextDiv);
      }
    }
    
    // Display historical context badge in metadata
    if (data.historical_context && data.historical_context.context_used) {
      const metaCard = document.getElementById("incidentMetadata");
      let badge = document.getElementById("historicalContextBadge");
      if (!badge) {
        badge = document.createElement("div");
        badge.id = "historicalContextBadge";
        badge.className = "historical-context-badge";
        metaCard.appendChild(badge);
      }
      badge.innerHTML = `
        <span>ðŸ§ </span>
        <span>Using ${data.historical_context.previous_analyses} previous analysis${data.historical_context.previous_analyses !== 1 ? 'es' : ''} for context</span>
      `;
      badge.style.display = "flex";
    }

    // AI Similarity Visualization
    if (data.adaptive_analysis && data.adaptive_analysis.similar_incidents_found > 0) {
      const similarityBox = document.getElementById("similarityBox");
      similarityBox.style.display = "block";
      
      const similarCount = data.adaptive_analysis.similar_incidents_found;
      const confidence = data.ai_confidence || Math.min(similarCount * 20, 100);
      
      document.getElementById("similarityText").textContent = 
        `This incident is similar to ${similarCount} past incident${similarCount > 1 ? 's' : ''}. AI confidence adjustment applied based on historical patterns.`;
      
      // Animate the bar
      setTimeout(() => {
        document.getElementById("similarityFill").style.width = confidence + "%";
      }, 100);
      
      document.getElementById("similarityPercentage").textContent = confidence + "%";
    }

    // GenAI Explanation Display
    if (data.ai_explanation) {
      const genaiCard = document.getElementById("genaiExplanation");
      genaiCard.style.display = "block";
      
      const content = document.getElementById("genaiContent");
      // Split by double newlines to create paragraphs
      const paragraphs = data.ai_explanation.split('\n\n');
      content.innerHTML = paragraphs.map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`).join('');
    }

    // Display risk warning if present
    if (data.risk_warning) {
      const riskCard = document.getElementById("riskWarning");
      riskCard.style.display = "block";
      document.getElementById("riskText").innerText = data.risk_warning.message;
      document.getElementById("riskSimilarity").innerText = `Similarity: ${data.risk_warning.similarity}% match with past failure`;
    } else {
      document.getElementById("riskWarning").style.display = "none";
    }

    // Highlight top root cause
    const probabilities = data.probabilities;
    let topCause = "";
    let maxValue = -1;

    for (let cause in probabilities) {
      if (probabilities[cause] > maxValue) {
        maxValue = probabilities[cause];
        topCause = cause;
      }
    }

    // Update stats cards
    document.getElementById("topCauseText").innerText = `${topCause} (${maxValue}%)`;
    document.getElementById("pmPreventStat").innerText = data.postmortem_summary.preventability;
    document.getElementById("eventCount").innerText = data.timeline.length;

    // Missed Intervention Detection
    if (data.missed_intervention) {
      document.getElementById("interventionCard").style.display = "block";
      document.getElementById("interventionText").innerText = data.missed_intervention.message;
      document.querySelector('.two-col').style.gridTemplateColumns = '1fr 1fr';
    } else {
      document.getElementById("interventionCard").style.display = "none";
      document.getElementById("postmortemCard").style.gridColumn = 'span 2';
    }

    // Automated Postmortem Summary
    document.getElementById("pmCause").innerText = data.postmortem_summary.primary_cause;
    document.getElementById("pmPrevent").innerText = data.postmortem_summary.preventability;
    document.getElementById("pmAction").innerText = data.postmortem_summary.recommended_action;

    document.getElementById("result").style.display = "block";

    // Timeline with severity styling and scroll animation
    const timeline = document.getElementById("timeline");
    timeline.innerHTML = "";
    
    // Store timeline data globally for pagination
    window.timelineData = data.timeline;
    window.timelineCurrentIndex = 0;
    window.timelineItemsPerPage = 10;
    
    // Render initial timeline items
    renderTimelineItems();

    // Initialize scroll-triggered timeline animations
    initTimelineScrollAnimation();

    // Causes with visual bars
    const causes = document.getElementById("causes");
    causes.innerHTML = "";
    for (let c in data.probabilities) {
      const div = document.createElement("div");
      div.className = "cause-item";
      div.innerHTML = `
        <div class="cause-header">
          <span class="cause-name">${c}</span>
          <span class="cause-percent">${data.probabilities[c]}%</span>
        </div>
        <div class="cause-bar-bg">
          <div class="cause-bar-fill" style="width: ${data.probabilities[c]}%"></div>
        </div>
      `;
      causes.appendChild(div);
    }

    // Explanations
    const explanation = document.getElementById("explanation");
    explanation.innerHTML = "";
    for (let e in data.explanations) {
      const li = document.createElement("li");
      li.innerHTML = `<b>${e}</b>${data.explanations[e]}`;
      explanation.appendChild(li);
    }

    // Render Charts
    renderCharts(data);
    
    // Display suggested questions if available
    if (data.suggested_questions && data.suggested_questions.length > 0) {
      const suggestedContainer = document.getElementById('suggestedQuestions');
      suggestedContainer.innerHTML = '';
      data.suggested_questions.forEach(q => {
        const chip = document.createElement('div');
        chip.className = 'suggested-question-chip';
        chip.textContent = q;
        chip.onclick = () => askSuggestedQuestion(q);
        suggestedContainer.appendChild(chip);
      });
      suggestedContainer.classList.add('active');
    }
  } catch (error) {
    document.getElementById("loading").classList.remove("active");
    document.getElementById("emptyState").style.display = "block";
    console.error("Analysis failed:", error);
    alert("Analysis failed. Check console for details.");
  }
}

// Override the analyze function to use the new one
window.analyze = analyzeWithMetadata;

// =============================
// Chatbot Functionality
// =============================
let chatMessages = [];
let chatOpen = false;

function toggleChat() {
  chatOpen = !chatOpen;
  const panel = document.getElementById('chatPanel');
  const button = document.getElementById('chatButton');
  
  if (chatOpen) {
    panel.classList.add('active');
    button.innerHTML = '<svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>';
  } else {
    panel.classList.remove('active');
    button.innerHTML = '<svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>';
  }
}

async function sendChatMessage() {
  const input = document.getElementById('chatInput');
  const question = input.value.trim();
  
  if (!question) return;
  
  // Add user message
  addChatMessage(question, 'user');
  input.value = '';
  
  // Show loading
  const loadingId = addChatMessage('Thinking...', 'ai', true);
  
  try {
    const response = await fetch('/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question })
    });
    
    const data = await response.json();
    
    // Remove loading message
    const loadingMsg = document.getElementById(loadingId);
    if (loadingMsg) loadingMsg.remove();
    
    // Add AI response
    addChatMessage(data.answer, 'ai');
    
  } catch (error) {
    const loadingMsg = document.getElementById(loadingId);
    if (loadingMsg) loadingMsg.remove();
    addChatMessage('Sorry, I encountered an error. Please try again.', 'ai');
    console.error('Chat error:', error);
  }
}

function addChatMessage(text, sender, isLoading = false) {
  const messagesContainer = document.getElementById('chatMessages');
  const messageDiv = document.createElement('div');
  const messageId = 'msg-' + Date.now();
  messageDiv.id = messageId;
  messageDiv.className = `chat-message ${sender}`;
  
  if (isLoading) {
    messageDiv.innerHTML = `
      <div class="message-content loading">
        <div class="loading-dots">
          <span></span><span></span><span></span>
        </div>
      </div>
    `;
  } else {
    messageDiv.innerHTML = `<div class="message-content">${escapeHtml(text)}</div>`;
  }
  
  messagesContainer.appendChild(messageDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
  
  return messageId;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML.replace(/\n/g, '<br>');
}

function askSuggestedQuestion(question) {
  const input = document.getElementById('chatInput');
  input.value = question;
  sendChatMessage();
}

// Allow Enter key to send
document.addEventListener('DOMContentLoaded', () => {
  const chatInput = document.getElementById('chatInput');
  if (chatInput) {
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendChatMessage();
      }
    });
  }
});
</script>

<!-- Chatbot UI -->
<div id="chatButton" class="chat-button" onclick="toggleChat()">
  <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
  </svg>
</div>

<div id="chatPanel" class="chat-panel">
  <div class="chat-header">
    <div>
      <h3>AI Assistant</h3>
      <p>Ask questions about your analysis</p>
    </div>
    <button onclick="toggleChat()" class="chat-close">Ã—</button>
  </div>
  
  <div id="chatMessages" class="chat-messages">
    <div class="chat-message ai">
      <div class="message-content">
        Hi! I'm your AI assistant. I can answer questions about your system analysis, logs, and findings. What would you like to know?
      </div>
    </div>
  </div>
  
  <div id="suggestedQuestions" class="suggested-questions">
    <!-- Will be populated after analysis -->
  </div>
  
  <div class="chat-input-container">
    <input 
      type="text" 
      id="chatInput" 
      class="chat-input" 
      placeholder="Ask a question..."
    />
    <button onclick="sendChatMessage()" class="chat-send">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
      </svg>
    </button>
  </div>
</div>

<style>
/* Chatbot Button */
.chat-button {
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 60px;
  height: 60px;
  background: linear-gradient(135deg, #8b5cf6, #6366f1);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
  transition: all 0.3s ease;
  z-index: 999;
}

.chat-button:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 30px rgba(139, 92, 246, 0.6);
}

.chat-button svg {
  color: white;
}

/* Chat Panel */
.chat-panel {
  position: fixed;
  bottom: -100%;
  right: 30px;
  width: 400px;
  height: 600px;
  background: rgba(20, 20, 28, 0.95);
  border: 1px solid rgba(139, 92, 246, 0.3);
  border-radius: 16px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(10px);
  display: flex;
  flex-direction: column;
  transition: bottom 0.4s ease;
  z-index: 998;
}

.chat-panel.active {
  bottom: 110px;
}

/* Chat Header */
.chat-header {
  padding: 20px;
  border-bottom: 1px solid rgba(139, 92, 246, 0.2);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.chat-header h3 {
  margin: 0;
  font-size: 18px;
  background: linear-gradient(135deg, #8b5cf6, #6366f1);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.chat-header p {
  margin: 4px 0 0 0;
  font-size: 12px;
  color: #999;
}

.chat-close {
  background: none;
  border: none;
  color: #999;
  font-size: 28px;
  cursor: pointer;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s;
}

.chat-close:hover {
  background: rgba(139, 92, 246, 0.1);
  color: #8b5cf6;
}

/* Messages Area */
.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.chat-message {
  display: flex;
  animation: slideInChat 0.3s ease;
}

@keyframes slideInChat {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.chat-message.user {
  justify-content: flex-end;
}

.chat-message.ai {
  justify-content: flex-start;
}

.message-content {
  max-width: 80%;
  padding: 12px 16px;
  border-radius: 12px;
  font-size: 14px;
  line-height: 1.5;
}

.chat-message.user .message-content {
  background: linear-gradient(135deg, #8b5cf6, #6366f1);
  color: white;
}

.chat-message.ai .message-content {
  background: rgba(139, 92, 246, 0.1);
  border: 1px solid rgba(139, 92, 246, 0.2);
  color: #e0e0e0;
}

.message-content.loading {
  padding: 16px;
}

.loading-dots {
  display: flex;
  gap: 6px;
  align-items: center;
  justify-content: center;
}

.loading-dots span {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #8b5cf6;
  animation: dotPulse 1.4s infinite;
}

.loading-dots span:nth-child(2) {
  animation-delay: 0.2s;
}

.loading-dots span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes dotPulse {
  0%, 60%, 100% {
    opacity: 0.3;
    transform: scale(0.8);
  }
  30% {
    opacity: 1;
    transform: scale(1);
  }
}

/* Suggested Questions */
.suggested-questions {
  padding: 12px 20px;
  border-top: 1px solid rgba(139, 92, 246, 0.2);
  display: none;
  flex-wrap: wrap;
  gap: 8px;
}

.suggested-questions.active {
  display: flex;
}

.suggested-question-chip {
  background: rgba(139, 92, 246, 0.1);
  border: 1px solid rgba(139, 92, 246, 0.3);
  border-radius: 16px;
  padding: 6px 12px;
  font-size: 12px;
  color: #a78bfa;
  cursor: pointer;
  transition: all 0.2s;
}

.suggested-question-chip:hover {
  background: rgba(139, 92, 246, 0.2);
  border-color: #8b5cf6;
}

/* Input Container */
.chat-input-container {
  padding: 16px 20px;
  border-top: 1px solid rgba(139, 92, 246, 0.2);
  display: flex;
  gap: 12px;
  align-items: center;
}

.chat-input {
  flex: 1;
  background: rgba(139, 92, 246, 0.05);
  border: 1px solid rgba(139, 92, 246, 0.2);
  border-radius: 8px;
  padding: 10px 14px;
  color: white;
  font-size: 14px;
  outline: none;
  transition: all 0.2s;
}

.chat-input:focus {
  border-color: #8b5cf6;
  background: rgba(139, 92, 246, 0.1);
}

.chat-send {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #8b5cf6, #6366f1);
  border: none;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.chat-send:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
}

.chat-send svg {
  color: white;
}

/* Scrollbar */
.chat-messages::-webkit-scrollbar {
  width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
  background: rgba(139, 92, 246, 0.05);
  border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb {
  background: rgba(139, 92, 246, 0.3);
  border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
  background: rgba(139, 92, 246, 0.5);
}

/* Responsive */
@media (max-width: 768px) {
  .chat-panel {
    right: 10px;
    left: 10px;
    width: auto;
  }
  
  .chat-button {
    right: 20px;
    bottom: 20px;
  }
}
</style>

<script>
// ============ Authentication & Project Setup ============
async function initDashboard() {
  try {
    // Get user info
    const userResp = await fetch('/auth/me');
    if (!userResp.ok) {
      window.location.href = '/login';
      return;
    }
    const user = await userResp.json();
    document.getElementById('userName').textContent = user.name || user.email;
    
    // Get current project
    const projectResp = await fetch('/projects/current');
    if (!projectResp.ok) {
      window.location.href = '/projects';
      return;
    }
    const project = await projectResp.json();
    document.getElementById('currentProjectName').textContent = project.name;
    
    // Load project's past reports
    loadProjectReports(project.id);
  } catch (err) {
    console.error('Init error:', err);
  }
}

async function loadProjectReports(projectId) {
  try {
    const resp = await fetch(`/projects/${projectId}/reports`);
    if (resp.ok) {
      const reports = await resp.json();
      // Update the past reports list with project-specific reports
      displayProjectReports(reports);
    }
  } catch (err) {
    console.error('Failed to load project reports:', err);
  }
}

function displayProjectReports(reports) {
  const container = document.getElementById('reportList');
  if (!reports || reports.length === 0) {
    container.innerHTML = '<p style="color: #71717a; font-size: 0.8rem;">No reports yet in this project</p>';
    return;
  }
  
  container.innerHTML = reports.slice(0, 5).map(r => {
    const analysis = r.analysis || {};
    const date = new Date(r.created_at).toLocaleDateString();
    return `
      <div class="report-item" style="padding: 8px; margin-bottom: 8px; background: rgba(255,255,255,0.03); border-radius: 8px; cursor: pointer;">
        <div style="font-size: 0.8rem; color: #fff;">${analysis.metadata?.incident_title || 'Untitled'}</div>
        <div style="font-size: 0.7rem; color: #71717a;">${date} â€¢ ${analysis.primary_root_cause || 'Unknown'}</div>
      </div>
    `;
  }).join('');
}

async function logout() {
  try {
    await fetch('/auth/logout', { method: 'POST' });
  } catch (err) {}
  window.location.href = '/login';
}

// Check if we're viewing a saved report
async function checkForSavedReport() {
  const urlParams = new URLSearchParams(window.location.search);
  const reportId = urlParams.get('report_id');
  console.log('checkForSavedReport - report_id:', reportId);
  
  if (reportId) {
    try {
      console.log('Fetching report from Firebase...');
      const response = await fetch(`/api/report/${reportId}`);
      
      if (response.ok) {
        const data = await response.json();
        console.log('Fetched report data:', data);
        
        // Display the report
        displaySavedReport(data);
        return true;
      } else {
        console.error('Failed to fetch report:', response.status);
      }
    } catch (err) {
      console.error('Failed to load saved report:', err);
    }
  }
  return false;
}

// Display a saved report with all visualizations
function displaySavedReport(data) {
  console.log('displaySavedReport called with data:', data);
  console.log('Data keys:', Object.keys(data));
  try {
    // Hide the report loading screen (use cssText to override !important)
    const loadingScreen = document.getElementById("reportLoadingScreen");
    if (loadingScreen) {
      loadingScreen.style.cssText = "display: none !important;";
      console.log('Hidden reportLoadingScreen');
    }
    
    // CRITICAL: Hide the incident form overlay first!
    const formOverlay = document.getElementById("incidentFormOverlay");
    if (formOverlay) {
      formOverlay.style.cssText = "display: none !important;";
      console.log('Hidden incidentFormOverlay');
    }
    
    // Hide the upload section since this is a read-only view
    const uploadSection = document.getElementById("uploadSection");
    if (uploadSection) {
      uploadSection.style.display = "none";
      console.log('Hidden uploadSection');
    }
    
    // Show the back to projects button
    const backSection = document.getElementById("backToProjectsSection");
    if (backSection) {
      backSection.style.display = "block";
      console.log('Shown backToProjectsSection');
    }
    
    // FIRST: Show the result container immediately
    const resultEl = document.getElementById("result");
    if (resultEl) {
      resultEl.style.display = "block";
      resultEl.style.visibility = "visible";
      console.log('Result container shown FIRST');
    }
    
    // Hide empty state - completely remove it from view
    const emptyState = document.getElementById("emptyState");
    if (emptyState) {
      emptyState.style.display = "none";
      emptyState.style.visibility = "hidden";
      emptyState.style.position = "absolute";
      emptyState.style.left = "-9999px";
      console.log('Hidden emptyState');
    }
    
    // Hide loading states
    const loadingEl = document.getElementById("loading");
    if (loadingEl) {
      loadingEl.style.display = "none";
      console.log('Hidden loading');
    }
    
    latestReport = data;

  // Display metadata if present
  console.log('Checking metadata:', data.metadata);
  if (data.metadata) {
    const metaCard = document.getElementById("incidentMetadata");
    if (metaCard) {
      metaCard.style.display = "block";
      console.log('Showing incidentMetadata card');
    }
    document.getElementById("meta_title").textContent = data.metadata.incident_title || "â€”";
    document.getElementById("meta_system").textContent = data.metadata.system_name || "â€”";
    
    const envBadge = document.getElementById("meta_env");
    envBadge.textContent = data.metadata.environment || "â€”";
    envBadge.setAttribute("data-env", data.metadata.environment);
    
    const sevBadge = document.getElementById("meta_severity");
    sevBadge.textContent = data.metadata.severity || "â€”";
    sevBadge.setAttribute("data-severity", data.metadata.severity);
    
    document.getElementById("meta_type").textContent = data.metadata.incident_type || "â€”";
    document.getElementById("meta_team").textContent = data.metadata.owning_team || "â€”";
    
    const alertBadge = document.getElementById("meta_alert");
    alertBadge.textContent = data.metadata.alert_triggered || "â€”";
    alertBadge.setAttribute("data-value", data.metadata.alert_triggered);
    
    const manualBadge = document.getElementById("meta_manual");
    manualBadge.textContent = data.metadata.manual_intervention || "â€”";
    manualBadge.setAttribute("data-value", data.metadata.manual_intervention);
  }

  // Display AI Adaptive Analysis
  if (data.adaptive_analysis) {
    const aiCard = document.getElementById("adaptiveAnalysis");
    aiCard.style.display = "block";
    
    const adaptive = data.adaptive_analysis;
    
    // Explanation as bullet list
    const explanationList = document.getElementById("adaptiveExplanation");
    explanationList.innerHTML = "";
    if (Array.isArray(adaptive.explanation)) {
      adaptive.explanation.forEach(point => {
        const li = document.createElement("li");
        li.textContent = point;
        explanationList.appendChild(li);
      });
    }
    
    // Risk Level
    const riskLevel = document.getElementById("aiRiskLevel");
    riskLevel.textContent = adaptive.risk_level;
    riskLevel.className = `adaptive-stat-value risk-${adaptive.risk_level}`;
    
    // Similar Incidents Count
    document.getElementById("aiSimilarCount").textContent = adaptive.similar_incidents_found || "0";
    
    // Dynamic Threshold
    const thresholds = adaptive.dynamic_thresholds_used;
    if (thresholds) {
      document.getElementById("aiThreshold").textContent = `${thresholds.alert_ignore} min`;
    }
    
    // Similar Incidents List
    const similarDiv = document.getElementById("similarIncidents");
    similarDiv.innerHTML = "";
    
    if (adaptive.similar_incidents && adaptive.similar_incidents.length > 0) {
      const title = document.createElement("h4");
      title.style.cssText = "color: #9ca3af; font-size: 0.85rem; margin-bottom: 12px; font-weight: 600;";
      title.textContent = "SIMILAR HISTORICAL INCIDENTS:";
      similarDiv.appendChild(title);
      
      adaptive.similar_incidents.forEach(incident => {
        const item = document.createElement("div");
        item.className = "similar-incident-item";
        item.innerHTML = `
          <span class="similar-incident-cause">${incident.root_cause}</span>
          <span class="similar-incident-match">${incident.similarity}% match</span>
        `;
        similarDiv.appendChild(item);
      });
    }
    
    // Display project historical context
    if (adaptive.project_context_applied) {
      const contextDiv = document.createElement("div");
      contextDiv.className = "project-context-section";
      contextDiv.style.cssText = "margin-top: 16px; padding: 12px; background: rgba(34, 197, 94, 0.05); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 8px;";
      contextDiv.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
          <span style="font-size: 1rem;">ðŸ“Š</span>
          <span style="color: #4ade80; font-size: 0.85rem; font-weight: 600;">Project Context Applied</span>
        </div>
        <p style="color: #a1a1aa; font-size: 0.8rem; margin: 0;">Analysis enhanced with patterns from previous logs in this project.</p>
      `;
      similarDiv.appendChild(contextDiv);
    }
  }
  
  // Display historical context badge in metadata
  if (data.historical_context && data.historical_context.context_used) {
    const metaCard = document.getElementById("incidentMetadata");
    let badge = document.getElementById("historicalContextBadge");
    if (!badge) {
      badge = document.createElement("div");
      badge.id = "historicalContextBadge";
      badge.className = "historical-context-badge";
      metaCard.appendChild(badge);
    }
    badge.innerHTML = `
      <span>ðŸ§ </span>
      <span>Using ${data.historical_context.previous_analyses} previous analysis${data.historical_context.previous_analyses !== 1 ? 'es' : ''} for context</span>
    `;
    badge.style.display = "flex";
  }

  // AI Similarity Visualization
  if (data.adaptive_analysis && data.adaptive_analysis.similar_incidents_found > 0) {
    const similarityBox = document.getElementById("similarityBox");
    if (similarityBox) {
      similarityBox.style.display = "block";
      
      const similarCount = data.adaptive_analysis.similar_incidents_found;
      const confidence = data.ai_confidence || Math.min(similarCount * 20, 100);
      
      document.getElementById("similarityText").textContent = 
        `This incident is similar to ${similarCount} past incident${similarCount > 1 ? 's' : ''}. AI confidence adjustment applied based on historical patterns.`;
      
      // Update percentage text
      document.getElementById("similarityPercentage").textContent = confidence + "%";
      
      setTimeout(() => {
        document.getElementById("similarityFill").style.width = confidence + "%";
      }, 300);
    }
  }

  // AI Explanation 
  if (data.ai_explanation) {
    const aiExplanationDiv = document.getElementById("aiExplanation");
    if (aiExplanationDiv) {
      aiExplanationDiv.style.display = "block";
      const aiExplanationText = document.getElementById("aiExplanationText");
      if (aiExplanationText) {
        if (typeof data.ai_explanation === 'string') {
          aiExplanationText.innerHTML = data.ai_explanation.replace(/\n/g, '<br>');
        } else if (data.ai_explanation.explanation) {
          aiExplanationText.innerHTML = data.ai_explanation.explanation.replace(/\n/g, '<br>');
        }
      }
    }
  }

  // Top causes and stats
  let maxValue = 0;
  let topCause = "";
  if (data.probabilities) {
    for (let cause in data.probabilities) {
      if (data.probabilities[cause] > maxValue) {
        maxValue = data.probabilities[cause];
        topCause = cause;
      }
    }
  }

  document.getElementById("topCauseText").innerText = topCause ? `${topCause} (${maxValue}%)` : "â€”";
  
  if (data.postmortem_summary) {
    document.getElementById("pmPreventStat").innerText = data.postmortem_summary.preventability || "-";
    document.getElementById("pmCause").innerText = data.postmortem_summary.primary_cause || "-";
    document.getElementById("pmPrevent").innerText = data.postmortem_summary.preventability || "-";
    document.getElementById("pmAction").innerText = data.postmortem_summary.recommended_action || "-";
  }
  
  if (data.timeline) {
    document.getElementById("eventCount").innerText = data.timeline.length;
  }

  // Missed Intervention Detection
  if (data.missed_intervention) {
    document.getElementById("interventionCard").style.display = "block";
    document.getElementById("interventionText").innerText = data.missed_intervention.message;
  } else {
    document.getElementById("interventionCard").style.display = "none";
  }

  // Scroll to results
  resultEl.scrollIntoView({ behavior: 'smooth' });

  // Timeline
  if (data.timeline) {
    window.timelineData = data.timeline;
    window.timelineCurrentIndex = 0;
    window.timelineItemsPerPage = 10;
    
    if (typeof renderTimelineItems === 'function') {
      renderTimelineItems();
    }
    
    if (typeof initTimelineScrollAnimation === 'function') {
      initTimelineScrollAnimation();
    }
  }

  // Causes with visual bars
  const causes = document.getElementById("causes");
  if (causes && data.probabilities) {
    causes.innerHTML = "";
    for (let c in data.probabilities) {
      const div = document.createElement("div");
      div.className = "cause-item";
      div.innerHTML = `
        <div class="cause-header">
          <span class="cause-name">${c}</span>
          <span class="cause-percent">${data.probabilities[c]}%</span>
        </div>
        <div class="cause-bar-bg">
          <div class="cause-bar-fill" style="width: ${data.probabilities[c]}%"></div>
        </div>
      `;
      causes.appendChild(div);
    }
  }

  // Explanations
  if (data.explanations) {
    const explanation = document.getElementById("explanation");
    explanation.innerHTML = "";
    for (let e in data.explanations) {
      const li = document.createElement("li");
      li.innerHTML = `<b>${e}</b>${data.explanations[e]}`;
      explanation.appendChild(li);
    }
  }

  // Render Charts
  if (typeof renderCharts === 'function') {
    renderCharts(data);
  }
  
  // Display suggested questions if available
  if (data.suggested_questions && data.suggested_questions.length > 0) {
    const suggestedContainer = document.getElementById('suggestedQuestions');
    if (suggestedContainer) {
      suggestedContainer.innerHTML = '';
      data.suggested_questions.forEach(q => {
        const chip = document.createElement('div');
        chip.className = 'suggested-question-chip';
        chip.textContent = q;
        chip.onclick = () => askSuggestedQuestion(q);
        suggestedContainer.appendChild(chip);
      });
      suggestedContainer.classList.add('active');
    }
  }
  
  console.log('displaySavedReport completed successfully');
  
  // Scroll to top after content is fully rendered
  setTimeout(() => {
    window.scrollTo(0, 0);
    const mainContent = document.querySelector('.main-content');
    if (mainContent) mainContent.scrollTop = 0;
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
  }, 150);
  
  } catch (err) {
    console.error('Error in displaySavedReport:', err);
  }
}

// Initialize on load
document.addEventListener('DOMContentLoaded', async function() {
  await initDashboard();
  await checkForSavedReport();
});
</script>

</body>
</html>
